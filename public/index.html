<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Bootstrap Form Builder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <link href="assets/css/bootstrap.css" rel="stylesheet">
    <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
        padding-bottom: 10px;
      }
      #components{
        min-height: 600px;
      }
      #target{
        min-height: 200px;
        border: 1px solid #ccc;
        padding: 5px;
      }
      #target .component{
        border: 1px solid #fff;
      }
      #temp{
        width: 500px;
        background: white;
        border: 1px dotted #ccc;
        border-radius: 10px;
      }

      .popover-content form {
        margin: 0 auto;
        width: 213px;
      }
      .popover-content form .btn{
        margin-right: 10px
      }
      #source{
        min-height: 500px;
      }

      form .popover {
        width: auto;
      }

      form .popover .controls {
        margin-left: 0;
      }

      form .popover .control-label {
        text-align: left;
      }

      form .popover form {
        width: 224px;
      }

    </style>
    <link href="assets/css/bootstrap-responsive.css" rel="stylesheet">

    <!--[if lt IE 9]>
    <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="#">Bootstrap Form Builder</a>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="row clearfix">
        <div class="span6">
          <div class="clearfix">
            <h2>Your Form</h2>
            <hr>
            <div id="build">
              <form id="target" class="form-horizontal">
                <fieldset>
                </fieldset>
              </form>
            </div>
          </div>
        </div>

        <div class="span6">
          <h2>Drag & Drop components</h2>
          <hr>
          <div class="tabbable">
            <ul class="nav nav-tabs" id="navtab">
              <!-- Tab nav -->
            </ul>
            <form class="form-horizontal" id="components">
              <fieldset>
                <div class="tab-content">
                  <!-- Tabs of snippets go here -->
                </div>
              </fieldset>
            </form>
          </div>
        </div>
      </div>

      <div class="row clearfix">
        <div class="span12">
          <hr>
          By Adam Moore (<a href="http://twitter.com/minikomi" >@minikomi</a>).<br/>
          Source on (<a href="http://github.com/minikomi" >Github</a>).
        </div>
      </div>
    </div> <!-- /container -->

    <!-- general js -->
    <script src="assets/js/jquery.js"></script>
    <script src="assets/js/bootstrap.js"></script>
    <script src="assets/js/bootstrap-tab.js"></script>

    <!-- backbone -->
    <script src="underscore-min.js" type="text/javascript"></script>
    <script src="backbone.js" type="text/javascript"></script>

    <!-- [templates] -->

    <!-- Popover -->
    <script type="text/html" id="popover-input">
      <label class='control-label'> <%= label %> </label> <input class='input-large' type='text' name='<%= id %>' id='<%= id %>' value ='<%= value %>' />
    </script>

    <script type="text/html" id="popover-textarea">
      <label class='control-label'> <%= label %> </label>
      <textarea style='min-height: 200px' id='<%= id %>'>
        <% for ( var i = 0; i < value.length ; i++ ) { %><%= value[i] + "\n" %><% } %>
      </textarea>
    </script>

    <script type="text/html" id="popover-main">
      <form class='form'>
        <div class='controls'>
          <% _.reduce(items, function(str, v, k){  %>
            <% v["id"] = k; %>
            <%= popoverItemTemplates[v["type"]](v) %>
            <% }, "") %>
          <hr/>
          <button class='btn btn-info'>Save</button><button class='btn btn-danger'>Cancel</button>
        </div>
      </form>
    </script>

    <!-- Tab  -->
    <script type="text/html" id="tab-nav">
      <li><a href="#<%= id %>" data-toggle="tab"><%= title %></a></li>
    </script>

    <!-- snippet -->
    <script type="text/html" id="snippet-textInput">
      <!-- Text input-->
      <label class="control-label" for="input01" data-valtype='label'><%= label %></label>
      <div class="controls">
        <input type="text" placeholder="<%= placeholder %>" class="input-xlarge" data-valtype="placeholder" >
        <p class="help-block" data-valtype='help'><%= helptext %></p>
      </div>
    </script>

    <script type="text/html" id="snippet-search">
      <!-- Search input-->
      <label class="control-label" data-valtype="label"><%= label %></label>
      <div class="controls">
        <input type="text" placeholder="<%= placeholder %>" class="input-xlarge search-query" data-valtype="placeholder">
        <p class="help-block" data-valtype="help"><%= helptext %></p>
      </div>
    </script>

    <script type="text/html" id="snippet-prepend">
      <!-- Prepended text-->
      <label class="control-label" data-valtype="label"><%= label %></label>
      <div class="controls">
        <div class="input-prepend">
          <span class="add-on" data-valtype="prepend"><%= prepend %></span>
          <input class="span2" placeholder="<%= placeholder %>" type="text" data-valtype="placeholder">
        </div>
        <p class="help-block" data-valtype="help"><%= helptext %></p>
      </div>
    </script>

    <script>
      // Set up templates
      var popoverInputTemplate    = _.template($("#popover-input").html());
      var popoverTextareaTemplate = _.template($("#popover-textarea").html());
      var popoverTemplate         = _.template($("#popover-main").html());
      var popoverItemTemplates    = {
        "text" : popoverInputTemplate,
        "textarea" : popoverTextareaTemplate,
      }
      var tabnavTemplate         = _.template($("#tab-nav").html());

      // Snippet Model / View
      var Snippet  = Backbone.Model.extend({});
      var SnippetView = Backbone.View.extend({
        tagName: "div",
        className: "control-group",
        initialize: function(){ this.template = _.template($("#snippet-"+ this.model.get("type")).html())},
        render: function(){
          return this.$el.html(this.template(
          _.reduce(this.model.toJSON(), function(o, v, k){
            if (k !== "type" || k !== "title") {o[k] = v["value"];}
            return o;
          },{})
          )).attr({
            "data-content"   : popoverTemplate({"items" : _.omit(this.model.toJSON(), "title", "type")})
            , "data-title"   : this.model.get("title")
            , "data-trigger" : "manual"
            , "data-html"    : true
          }).popover()
        }
      });

      // Tab Collection / View
      var TabSnippetsCollection = Backbone.Collection.extend({
        model: Snippet
      });
      var Tab = Backbone.View.extend({
        tagName: "div"
        , className: "tab-pane"

        , initialize: function(obj){
          var that = this;
          that._snippetViews = [];
          this.collection.each(function(snippet){
            that._snippetViews.push(new SnippetView({model: snippet}));
          });
        }

        , render: function(){

          //Render Snippet Views
          var that = this;
          _.each(this._snippetViews, function(snippetView){
            that.$el.append(snippetView.render())
          });
          this.$el.attr("id", this.id)

          //render & append nav
          $(".nav.nav-tabs").append(tabnavTemplate({title: this._title, id: this.id}))

          //append tab pane
          this.$el.appendTo(".tab-content");
          this.delegateEvents();
        }

        , events:{
          "click .control-group" : "clicked"
        }
        , clicked: function(){console.log("hi")} // test for events

        // Set title text for nav.
        , setTitle: function(title){
          this._title = title;
          this.id     = this._title.toLowerCase().replace(/\W/g,'');
        }
      });

      // Convinience functions
      var tabMaker = function(title, snippetCollection){
        var tab = new Tab({collection : snippetCollection})
        tab.setTitle(title);
        tab.render();
      }
      
      //--- App Setup ---

      // Create Snippets
      var textInput = new Snippet({
        "type"    : "textInput"
        , "title" : "Text Input"

        , "label"       : {"label"    : "Label Text"  , "type" : "text" , "value" : "label"}
        , "prepend"     : {"label"    : "Prepend"     , "type" : "text" , "value" : "prepend"}
        , "placeholder" : {"label"    : "Placeholder" , "type" : "text" , "value" : "placeholder"}
        , "helptext"    : {"label"    : "Help Text"   , "type" : "text" , "value" : "help"}
      });

      // Bundle snippets for tabs
      var textInputSnippets = new TabSnippetsCollection([
        textInput
      ]);
  
      // Make tabs
      tabMaker("Text Inputs", textInputSnippets)
      tabMaker("banana", textInputSnippets)

      //Make the first tab active!
      $(".tab-pane").first().addClass("active");
      $("ul.nav li").first().addClass("active");

    </script>
  </body>
</html>
